// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA2HXbZ3wx7AueJfcfyXxaEgbd19rS92GU",
  authDomain: "classroomhub-b7fb2.firebaseapp.com",
  projectId: "classroomhub-b7fb2",
  // Use the correct bucket name for gsutil and Firebase Storage
  storageBucket: "classroomhub-b7fb2.appspot.com",
  messagingSenderId: "738515755753",
  appId: "1:738515755753:web:8cbaba514b7f4d18d10678",
  measurementId: "G-BD9JP78661"
};

firebase.initializeApp(firebaseConfig);
const storage = firebase.storage();

const sections = [
  { id: "materials", input: "materialsFile", list: "materialsList", icon: "📚" },
  { id: "documents", input: "documentsFile", list: "documentsList", icon: "📄" },
  { id: "homework", input: "homeworkFile", list: "homeworkList", icon: "📝" },
  { id: "notebooks", input: "notebooksFile", list: "notebooksList", icon: "📒" }
];

function createFileEntry(name, url, category) {
  const entry = document.createElement("div");
  entry.className = "file-entry";
  entry.innerHTML = `
    <span>📄 <strong>${name}</strong></span>
    <span>
      <a href="${url}" target="_blank" rel="noopener">[Open]</a>
      <button class="delete-btn" data-name="${name}" data-category="${category}">Delete</button>
    </span>
  `;
  return entry;
}

function uploadFile(file, category, list) {
  const storageRef = storage.ref(`${category}/${file.name}`);
  const uploadTask = storageRef.put(file);

  const loading = document.createElement("div");
  loading.className = "file-entry";
  loading.textContent = `Uploading ${file.name}: 0%`; // This will show percentage with Firebase
  list.appendChild(loading);

  uploadTask.on(
    firebase.storage.TaskEvent.STATE_CHANGED, // Use the correct Firebase event
    (snapshot) => {
      const progress = Math.floor((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
      loading.textContent = `Uploading ${file.name}: ${progress}%`;
    },
    (err) => {
      loading.textContent = `❌ Failed to upload ${file.name}`;
      console.error("Upload Error:", err); // Log the error for debugging
      alert(`Failed to upload ${file.name}. See console for details.`); // User friendly error
    },
    () => {
      uploadTask.snapshot.ref.getDownloadURL().then((url) => {
        const entry = createFileEntry(file.name, url, category);
        // Replace the loading entry with the final file entry
        // Find the loading element by its text content or class if needed, or ensure it's the last child
        list.removeChild(loading); // Remove the loading message
        list.appendChild(entry); // Add the final entry
        alert(`${file.name} uploaded successfully!`); // Success message
      }).catch(err => {
           loading.textContent = `❌ Failed to get download URL for ${file.name}`;
           console.error("Get Download URL Error:", err);
           alert(`Upload complete, but failed to get URL for ${file.name}.`);
      });
    }
  );
}

function deleteFile(name, category, entry) {
  // Added confirmation dialog
  if (!confirm(`Are you sure you want to delete "${name}" from ${category}?`)) {
    return; // Stop if user cancels
  }

  const ref = storage.ref(`${category}/${name}`);
  ref.delete()
    .then(() => {
      entry.remove(); // Remove the file entry from the UI
      alert(`"${name}" deleted successfully.`); // Success message
    })
    .catch((error) => {
      alert("Failed to delete file.");
      console.error("Delete Error:", error); // Log the error
    });
}

function listFiles(category, container) {
  container.innerHTML = "<div class='file-entry'>Loading files...</div>"; // Loading state for listing
  const listRef = storage.ref(category);
  listRef.listAll().then((res) => {
    container.innerHTML = ""; // Clear loading/previous list
    if (res.items.length === 0) {
      container.innerHTML = "<div class='file-entry'>No files uploaded yet.</div>"; // Empty state
    } else {
       // Sort files alphabetically by name before displaying
      const filePromises = res.items.map(itemRef =>
        itemRef.getDownloadURL().then(url => ({ name: itemRef.name, url: url }))
      );

      Promise.all(filePromises).then(files => {
          files.sort((a, b) => a.name.localeCompare(b.name)); // Sort by name
          files.forEach(fileObj => createFileEntry(fileObj, category, container));
      });
    }
  }).catch(error => {
      container.innerHTML = `<div class='file-entry'>❌ Failed to list files.</div>`;
      console.error("List Files Error:", error);
      alert("Failed to load files from storage.");
  });
}

// Event listeners for file inputs and delete buttons
sections.forEach(({ id, input, list }) => {
  const fileInput = document.getElementById(input);
  const fileList = document.getElementById(list);

  fileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
        uploadFile(file, id, fileList);
    }
    fileInput.value = ""; // Reset input field after selection
  });

   // Use event delegation for delete buttons
  fileList.addEventListener("click", (e) => {
    if (e.target.classList.contains("delete-btn")) {
      const name = e.target.getAttribute("data-name");
      const category = e.target.getAttribute("data-category");
      const entryElement = e.target.closest(".file-entry"); // Get the parent file entry element
      if (name && category && entryElement) { // Ensure attributes and element are found
         deleteFile(name, category, entryElement);
      }
    }
  });

  // Initial listing of files when the DOM is ready
  document.addEventListener("DOMContentLoaded", () => {
    listFiles(id, fileList);
  });
});

// Optional: Add tab switching functionality if you implemented tabs in HTML/CSS
// This part is not included in the basic HTML above, but you can add it if you like.
// function showSection(sectionId) {
//     sections.forEach(section => {
//         const element = document.getElementById(`${section.id}-section`);
//         if (element) {
//             element.style.display = section.id === sectionId ? 'block' : 'none';
//         }
//     });
//     // Update active tab class
//     document.querySelectorAll('.section-tabs a').forEach(tab => {
//         if (tab.getAttribute('href').substring(1) === sectionId) {
//             tab.classList.add('active'); // You'll need CSS for .active
//         } else {
//             tab.classList.remove('active');
//         }
//     });
// }

// document.addEventListener("DOMContentLoaded", () => {
//     // Add click listeners to tabs for section switching
//     document.querySelectorAll('.section-tabs a').forEach(tab => {
//         tab.addEventListener('click', (e) => {
//             e.preventDefault();
//             const targetSectionId = e.target.getAttribute('href').substring(1);
//             showSection(targetSectionId);
//         });
//     });
//     // Show the first section by default
//     if (sections.length > 0) {
//         showSection(sections[0].id);
//     }
// });
